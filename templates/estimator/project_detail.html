{% extends "estimator/base_dashboard.html" %}
{% load humanize extra_filters %}

{% block page_title %}Project: {{ project.name }}{% endblock %}

{% block content %}

<!-- Summary Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body text-center">
                <h5>Your Estimate</h5>
                <h3>RM {{ total_est|floatformat:2|intcomma }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger">
            <div class="card-body text-center">
                <h5>CIDB Rate</h5>
                <h3>RM {{ total_cidb|floatformat:2|intcomma }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white {% if total_variance > 0 %}bg-warning{% else %}bg-success{% endif %}">
            <div class="card-body text-center">
                <h5>Variance</h5>
                <h3>
                    {% if total_variance > 0 %}+{% endif %}
                    RM {{ total_variance|floatformat:2|intcomma }}
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center">
                <h5>Actual Cost</h5>
                <h3>RM {{ actual_total|floatformat:2|intcomma }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="mb-3">
    {% if user.userprofile.role in 'qs,admin' or user.is_staff %}
        <a href="{% url 'edit_actuals' project.pk %}" class="btn btn-sm btn-outline-primary">Edit Actuals</a>
        <a href="{% url 'project_edit' project.pk %}" class="btn btn-sm btn-outline-info">Edit Details</a>
        <a href="{% url 'run_forecast_view' project.pk %}" class="btn btn-sm btn-success">Run Forecast</a>
        
        {% with forecast_count=project.forecast_set.count %}
            {% if forecast_count > 0 %}
                <a href="{% url 'view_forecast' project.pk %}" class="btn btn-sm btn-warning">
                    View Forecast ({{ forecast_count }})
                </a>
            {% endif %}
        {% endwith %}
    {% endif %}
</div>

<!-- Tabs for Breakdown and Inflation -->
<ul class="nav nav-tabs mb-3">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#breakdown">Breakdown</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#inflation">Inflation</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#actuals">Actuals</a></li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade show active" id="breakdown">
        {% include "estimator/breakdown_table.html" with use_original=True total_est=original_total_est total_variance=original_total_est|subtract:total_cidb %}
        <div class="card mt-4 shadow-sm">
            <div class="card-header bg-light"><h5>Cost Trend</h5></div>
            <div class="card-body">
                <canvas id="breakdownChart" height="120"></canvas>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="inflation">
        <form method="post" class="mt-3">
            {% csrf_token %}
            <div class="input-group w-50">
                <input type="number" step="0.01" name="inflation_rate" class="form-control"
                       placeholder="Inflation % (e.g. 3.5)" required>
                <button type="submit" name="apply_inflation" class="btn btn-warning">Apply</button>
            </div>
        </form>

        {% if inflation_applied %}
        <div class="alert alert-info mt-3">
            Inflation <strong>{{ inflation_rate }}%</strong> applied on {{ inflation_applied_at|date:"d/m/Y H:i" }}.
            <form method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" name="revert_inflation" class="btn btn-sm btn-danger ms-2">Revert</button>
            </form>
        </div>
        {% endif %}

        {% include "estimator/breakdown_table.html" with use_original=False total_est=total_est total_variance=total_variance %}
        <div class="card mt-4 shadow-sm">
            <div class="card-header bg-light"><h5>Cost Trend</h5></div>
            <div class="card-body">
                <canvas id="inflationChart" height="120"></canvas>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="actuals">
        <div class="table-responsive">
            <table class="table table-striped mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Item</th>
                        <th>Description</th>
                        <th class="text-end">Est Qty</th>
                        <th class="text-end">Est Rate</th>
                        <th class="text-end">Est Cost</th>
                        <th class="text-end">Actual Qty</th>
                        <th class="text-end">Actual Rate</th>
                        <th class="text-end">Actual Cost</th>
                        <th class="text-end">Diff</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in breakdown %}
                    {% with actual=row.actual %}
                    <tr>
                        <td>{{ row.item.section }}</td>
                        <td>{{ row.item.description }}</td>
                        <td class="text-end">{{ row.item.quantity }}</td>
                        <td class="text-end">{{ row.item.rate|floatformat:2 }}</td>
                        <td class="text-end">{{ row.est_cost|floatformat:2|intcomma }}</td>
                        <!-- FIXED: Show blank instead of estimated data for actuals -->
                        <td class="text-end">{{ actual.quantity_actual|default:'' }}</td>
                        <td class="text-end">{{ actual.rate_actual|default:'' }}</td>
                        <td class="text-end">{{ actual.amount_actual|default:''|floatformat:2|intcomma }}</td>
                        <td class="text-end {% if actual.amount_actual and actual.amount_actual > row.est_cost %}text-danger{% else %}text-success{% endif %}">
                            {% if actual.amount_actual %}
                            {{ actual.amount_actual|subtract:row.est_cost|floatformat:2|intcomma }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                    <tr class="table-info fw-bold">
                        <td colspan="4" class="text-end">TOTAL</td>
                        <td class="text-end">{{ total_est|floatformat:2|intcomma }}</td>
                        <td colspan="2"></td>
                        <td class="text-end">{{ actual_total|floatformat:2|intcomma }}</td>
                        <td class="text-end">{{ actual_total|subtract:total_est|floatformat:2|intcomma }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="card mt-4 shadow-sm">
            <div class="card-header bg-light"><h5>Cost Trend</h5></div>
            <div class="card-body">
                <canvas id="actualsChart" height="120"></canvas>
            </div>
        </div>
    </div>

{% if actual_total %}
<hr>
<h5>Profitability: {{ project.profitability|default:"N/A" }}%</h5>
<p>(Calculated as (Estimated Cost - Actual Cost) / Estimated Cost * 100%. This represents the percentage savings or overrun based on the estimated vs. actual costs.)</p>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('breakdownChart')) {
        const ctxBreakdown = document.getElementById('breakdownChart').getContext('2d');
        new Chart(ctxBreakdown, {
            type: 'bar',
            data: {{ breakdown_chart_data|safe }},
            options: { responsive: true, plugins: { legend: { position: 'top', labels: { pointStyle: 'rect' } } } }
        });
    }
    if (document.getElementById('inflationChart')) {
        const ctxInflation = document.getElementById('inflationChart').getContext('2d');
        new Chart(ctxInflation, {
            type: 'bar',
            data: {{ inflation_chart_data|safe }},
            options: { responsive: true, plugins: { legend: { position: 'top', labels: { pointStyle: 'rect' } } } }
        });
    }
    if (document.getElementById('actualsChart')) {
        const ctxActuals = document.getElementById('actualsChart').getContext('2d');
        new Chart(ctxActuals, {
            type: 'bar',
            data: {{ actuals_chart_data|safe }},
            options: { responsive: true, plugins: { legend: { position: 'top', labels: { pointStyle: 'rect' } } } }
        });
    }
});
</script>
{% endblock %}