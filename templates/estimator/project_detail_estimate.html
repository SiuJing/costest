{% load humanize extra_filters %}

<!-- ESTIMATE PARTIAL — NO EXTENDS, NO BLOCKS -->

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">{{ project.name }}</h2>
    <a href="{% url 'adjust_inflation' project.pk %}" class="btn btn-warning">Adjust Inflation</a>
</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card text-center bg-info text-white h-100">
            <div class="card-body">
                <h5 class="card-title">Your Estimate</h5>
                <p class="card-text display-6 mb-0">
                    RM {{ project.estimated_cost|floatformat:2|intcomma }}
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center bg-danger text-white h-100">
            <div class="card-body">
                <h5 class="card-title">CIDB Rate</h5>
                <p class="card-text display-6 mb-0">
                    RM {{ project.cidb_cost|floatformat:2|intcomma }}
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center bg-{% if project.estimated_cost < project.cidb_cost|default:0 %}success{% else %}warning{% endif %} text-white h-100">
            <div class="card-body">
                <h5 class="card-title">Variance</h5>
                <p class="card-text display-6 mb-0">
                    {% with total=project.estimated_cost|default:0 cidb=project.cidb_cost|default:0 %}
                        {% widthratio total 1 cidb as diff %}
                        {% if diff < 0 %}
                            -RM {{ diff|abs|floatformat:2|intcomma }}
                        {% else %}
                            +RM {{ diff|floatformat:2|intcomma }}
                        {% endif %}
                    {% endwith %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Cost Breakdown Table -->
<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Cost Breakdown</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Item</th>
                        <th class="text-end">Quantity</th>
                        <th class="text-end">Unit</th>
                        <th class="text-end">Rate (RM)</th>
                        <th class="text-end">Your Cost</th>
                        <th class="text-end">CIDB Cost</th>
                        <th class="text-end">Diff</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td>{{ item.description }}</td>
                        <td class="text-end">{{ item.quantity|floatformat:2 }}</td>
                        <td class="text-end">{{ item.unit }}</td>
                        <td class="text-end">{{ item.rate|floatformat:2|intcomma }}</td>
                        <td class="text-end">RM {{ item.amount|floatformat:2|intcomma }}</td>
                        <td class="text-end">RM {{ item.cidb_amount|default:0|floatformat:2|intcomma }}</td>
                        <td class="text-end">
                            {% with total=item.amount|default:0 cidb=item.cidb_amount|default:0 %}
                                {% if total or cidb %}
                                    {% widthratio total 1 cidb as diff %}
                                    <span class="{% if diff < 0 %}text-success{% else %}text-danger{% endif %}">
                                        {% if diff < 0 %}
                                            -RM {{ diff|abs|floatformat:2|intcomma }}
                                        {% else %}
                                            +RM {{ diff|floatformat:2|intcomma }}
                                        {% endif %}
                                    </span>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            {% endwith %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">No items added yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>